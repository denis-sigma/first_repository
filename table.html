<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DataVision | Анализ CSV</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
          --primary: #8B5FBF;
          --primary-dark: #6D3FA3;
          --primary-light: #9D7BC9;
          --secondary: #2EC4B6;
          --secondary-dark: #20A294;
          --accent: #FF6B6B;
          --dark: #1A1A2E;
          --darker: #16213E;
          --light: #F8F9FA;
          --gray: #8B9BB4;
          --gray-dark: #4A5568;
          --success: #06D6A0;
          --warning: #FFD166;
          --error: #EF476F;
          --border: #2D3748;
          --shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
          --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.35);
          --radius: 16px;
          --radius-sm: 8px;
          --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
          --gradient: linear-gradient(135deg, var(--primary), var(--secondary));
          --gradient-dark: linear-gradient(135deg, var(--primary-dark), var(--secondary-dark));
        }

        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        body {
          font-family: 'Inter', sans-serif;
          background: var(--darker);
          color: var(--light);
          min-height: 100vh;
          padding: 20px;
          line-height: 1.6;
        }

        .container {
          max-width: 1400px;
          margin: 0 auto;
          width: 100%;
        }

        .main-card {
          background: var(--dark);
          border-radius: var(--radius);
          box-shadow: var(--shadow-lg);
          overflow: hidden;
          margin-bottom: 20px;
          border: 1px solid var(--border);
        }

        .header {
          background: var(--gradient-dark);
          padding: 30px 20px;
          text-align: center;
          position: relative;
          overflow: hidden;
        }

        .header::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
          opacity: 0.3;
        }

        .header-content {
          position: relative;
          z-index: 2;
        }

        .header h1 {
          font-size: 2.5rem;
          font-weight: 800;
          margin-bottom: 10px;
          background: linear-gradient(90deg, #fff, var(--secondary));
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header p {
          font-size: 1.1rem;
          opacity: 0.9;
          font-weight: 400;
          max-width: 600px;
          margin: 0 auto;
        }

        .main-content {
          padding: 30px;
          display: grid;
          grid-template-columns: 1fr 2fr;
          gap: 30px;
          align-items: start;
        }

        .upload-section {
          background: var(--dark);
          padding: 25px;
          border-radius: var(--radius);
          box-shadow: var(--shadow);
          border: 1px solid var(--border);
          height: fit-content;
          position: sticky;
          top: 20px;
        }

        .upload-area {
          border: 2px dashed var(--border);
          border-radius: var(--radius);
          padding: 35px 20px;
          text-align: center;
          transition: var(--transition);
          background: rgba(26, 26, 46, 0.7);
          cursor: pointer;
          margin-bottom: 25px;
          position: relative;
          overflow: hidden;
        }

        .upload-area::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(139, 95, 191, 0.1), transparent);
          transition: var(--transition);
        }

        .upload-area:hover::before {
          left: 100%;
        }

        .upload-area:hover {
          border-color: var(--primary);
          background: rgba(139, 95, 191, 0.05);
        }

        .upload-area.active {
          border-color: var(--success);
          background: rgba(6, 214, 160, 0.05);
        }

        .upload-area.has-error {
          border-color: var(--error);
          background: rgba(239, 71, 111, 0.05);
        }

        .upload-icon {
          font-size: 3rem;
          margin-bottom: 20px;
          display: block;
          opacity: 0.8;
        }

        .file-input {
          display: none;
        }

        .btn {
          background: var(--gradient);
          color: white;
          border: none;
          padding: 14px 24px;
          border-radius: var(--radius-sm);
          font-weight: 600;
          cursor: pointer;
          transition: var(--transition);
          font-size: 0.95rem;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
          width: 100%;
          box-shadow: 0 4px 15px rgba(139, 95, 191, 0.3);
          position: relative;
          overflow: hidden;
        }

        .btn::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
          transition: var(--transition);
        }

        .btn:hover::before {
          left: 100%;
        }

        .btn:hover {
          transform: translateY(-3px);
          box-shadow: 0 8px 20px rgba(139, 95, 191, 0.4);
        }

        .btn-secondary {
          background: var(--gradient-dark);
          box-shadow: 0 4px 15px rgba(46, 196, 182, 0.3);
        }

        .btn-secondary:hover {
          box-shadow: 0 8px 20px rgba(46, 196, 182, 0.4);
        }

        .status-card {
          padding: 20px;
          border-radius: var(--radius-sm);
          margin-bottom: 20px;
          box-shadow: var(--shadow);
          border-left: 4px solid;
          background: var(--darker);
        }

        .status-success {
          border-left-color: var(--success);
          background: rgba(6, 214, 160, 0.1);
        }

        .status-error {
          border-left-color: var(--error);
          background: rgba(239, 71, 111, 0.1);
        }

        .status-warning {
          border-left-color: var(--warning);
          background: rgba(255, 209, 102, 0.1);
        }

        .status-info {
          border-left-color: var(--secondary);
          background: rgba(46, 196, 182, 0.1);
        }

        .quality-stats {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 15px;
          margin: 20px 0;
        }

        .stat-card {
          background: var(--darker);
          padding: 18px;
          border-radius: var(--radius-sm);
          box-shadow: var(--shadow);
          text-align: center;
          border-top: 3px solid var(--primary);
          transition: var(--transition);
        }

        .stat-card:hover {
          transform: translateY(-5px);
          box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .stat-value {
          font-size: 1.6rem;
          font-weight: 700;
          color: var(--primary);
          margin-bottom: 5px;
        }

        .stat-label {
          font-size: 0.85rem;
          color: var(--gray);
          font-weight: 500;
        }

        .analysis-section {
          background: var(--dark);
          padding: 25px;
          border-radius: var(--radius);
          box-shadow: var(--shadow);
          border: 1px solid var(--border);
          min-width: 0;
        }

        .section-title {
          font-size: 1.4rem;
          font-weight: 700;
          color: var(--light);
          margin-bottom: 25px;
          display: flex;
          align-items: center;
          gap: 12px;
          padding-bottom: 12px;
          border-bottom: 1px solid var(--border);
        }

        .section-title::before {
          content: '';
          width: 5px;
          height: 24px;
          background: var(--gradient);
          border-radius: 2px;
        }

        .year-selector {
          display: flex;
          gap: 15px;
          align-items: center;
          margin-bottom: 25px;
          flex-wrap: wrap;
          background: var(--darker);
          padding: 15px;
          border-radius: var(--radius-sm);
        }

        .select {
          padding: 12px 16px;
          border: 1px solid var(--border);
          border-radius: var(--radius-sm);
          font-size: 0.95rem;
          background: var(--dark);
          color: var(--light);
          min-width: 140px;
          transition: var(--transition);
          flex: 1;
        }

        .select:focus {
          outline: none;
          border-color: var(--primary);
          box-shadow: 0 0 0 3px rgba(139, 95, 191, 0.2);
        }

        .data-table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 20px;
          box-shadow: var(--shadow);
          border-radius: var(--radius-sm);
          overflow: hidden;
          min-width: 600px;
        }

        .data-table th {
          background: var(--gradient-dark);
          color: white;
          padding: 16px;
          text-align: left;
          font-weight: 600;
          font-size: 0.85rem;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .data-table td {
          padding: 16px;
          border-bottom: 1px solid var(--border);
          font-weight: 400;
          font-size: 0.9rem;
          background: var(--darker);
        }

        .data-table tr:hover td {
          background: rgba(139, 95, 191, 0.1);
        }

        .data-table tr:last-child td {
          border-bottom: none;
        }

        .city-info {
          font-size: 0.8rem;
          color: var(--gray);
          margin-top: 4px;
        }

        .city-highlight {
          color: var(--secondary);
          font-weight: 500;
        }

        .summary-cards {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
          gap: 20px;
          margin-bottom: 25px;
        }

        .summary-card {
          background: var(--gradient);
          color: white;
          padding: 25px;
          border-radius: var(--radius-sm);
          box-shadow: var(--shadow);
          position: relative;
          overflow: hidden;
        }

        .summary-card::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
          opacity: 0.3;
        }

        .summary-card-content {
          position: relative;
          z-index: 2;
        }

        .summary-card h3 {
          font-size: 0.9rem;
          font-weight: 500;
          margin-bottom: 10px;
          opacity: 0.9;
        }

        .summary-card .value {
          font-size: 1.8rem;
          font-weight: 800;
          margin-bottom: 5px;
        }

        .summary-card p {
          font-size: 0.85rem;
          opacity: 0.9;
        }

        .hidden {
          display: none;
        }

        .fade-in {
          animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
          animation: pulse 2s infinite;
        }

        @keyframes pulse {
          0% { transform: scale(1); }
          50% { transform: scale(1.05); }
          100% { transform: scale(1); }
        }

        .action-buttons {
          display: flex;
          flex-direction: column;
          gap: 12px;
          margin-top: 20px;
        }

        .missing-states {
          background: rgba(255, 209, 102, 0.1);
          border: 1px solid var(--warning);
          border-radius: var(--radius-sm);
          padding: 18px;
          margin: 20px 0;
        }

        .missing-states h4 {
          color: var(--warning);
          margin-bottom: 12px;
          font-weight: 600;
          font-size: 0.95rem;
        }

        .missing-states-list {
          display: flex;
          flex-wrap: wrap;
          gap: 8px;
        }

        .state-tag {
          background: var(--warning);
          color: var(--dark);
          padding: 6px 12px;
          border-radius: 20px;
          font-size: 0.8rem;
          font-weight: 600;
        }

        .data-issues {
          background: rgba(239, 71, 111, 0.1);
          border: 1px solid var(--error);
          border-radius: var(--radius-sm);
          padding: 18px;
          margin: 20px 0;
        }

        .data-issues h4 {
          color: var(--error);
          margin-bottom: 12px;
          font-weight: 600;
          font-size: 0.95rem;
        }

        .issues-list {
          display: flex;
          flex-direction: column;
          gap: 10px;
        }

        .issue-item {
          display: flex;
          align-items: center;
          gap: 10px;
          font-size: 0.85rem;
        }

        .table-container {
          overflow-x: auto;
          margin-top: 20px;
          border-radius: var(--radius-sm);
          border: 1px solid var(--border);
        }

        /* Строчная диаграмма */
        .bar-chart {
          margin-top: 30px;
          background: var(--darker);
          padding: 25px;
          border-radius: var(--radius-sm);
          box-shadow: var(--shadow);
          border: 1px solid var(--border);
        }

        .bar-chart-title {
          font-size: 1.2rem;
          font-weight: 700;
          margin-bottom: 20px;
          color: var(--light);
        }

        .bar-item {
          display: flex;
          align-items: center;
          margin-bottom: 15px;
          gap: 20px;
        }

        .bar-label {
          min-width: 140px;
          font-weight: 600;
          font-size: 0.9rem;
          color: var(--light);
        }

        .bar-container {
          flex: 1;
          height: 35px;
          background: var(--dark);
          border-radius: 20px;
          overflow: hidden;
          position: relative;
          box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .bar-fill {
          height: 100%;
          background: var(--gradient);
          border-radius: 20px;
          transition: all 0.8s ease-in-out;
          min-width: 3px;
          position: relative;
          box-shadow: 0 2px 10px rgba(139, 95, 191, 0.4);
        }

        .bar-value {
          position: absolute;
          right: 15px;
          top: 50%;
          transform: translateY(-50%);
          font-size: 0.85rem;
          font-weight: 600;
          color: var(--light);
          z-index: 2;
        }

        .bar-percentage {
          position: absolute;
          left: 15px;
          top: 50%;
          transform: translateY(-50%);
          font-size: 0.8rem;
          font-weight: 600;
          color: white;
          z-index: 2;
          text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .empty-cells-warning {
          background: rgba(255, 209, 102, 0.1);
          border: 1px solid var(--warning);
          border-radius: var(--radius-sm);
          padding: 18px;
          margin: 20px 0;
        }

        .empty-cells-warning h4 {
          color: var(--warning);
          margin-bottom: 12px;
          font-weight: 600;
          font-size: 0.95rem;
        }

        .empty-cells-list {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
          gap: 12px;
          font-size: 0.85rem;
        }

        .empty-cell-item {
          display: flex;
          align-items: center;
          gap: 10px;
          padding: 8px;
          background: rgba(255, 255, 255, 0.05);
          border-radius: var(--radius-sm);
        }

        @media (max-width: 1024px) {
          .main-content {
            grid-template-columns: 1fr;
            gap: 25px;
          }

          .upload-section {
            position: static;
          }
        }

        @media (max-width: 768px) {
          body {
            padding: 15px 10px;
          }

          .header h1 {
            font-size: 2rem;
          }

          .main-content {
            padding: 20px 15px;
            grid-template-columns: 1fr;
          }

          .upload-section, .analysis-section {
            padding: 20px;
          }

          .quality-stats {
            grid-template-columns: 1fr;
          }

          .summary-cards {
            grid-template-columns: 1fr;
          }

          .year-selector {
            flex-direction: column;
            align-items: stretch;
          }

          .select {
            min-width: auto;
          }

          .data-table {
            min-width: 500px;
          }

          .btn {
            font-size: 0.9rem;
            padding: 12px 20px;
          }

          .bar-item {
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
          }

          .bar-label {
            min-width: auto;
          }

          .empty-cells-list {
            grid-template-columns: 1fr;
          }
        }

        @media (max-width: 480px) {
          .header {
            padding: 25px 15px;
          }

          .header h1 {
            font-size: 1.8rem;
          }

          .upload-area {
            padding: 25px 15px;
          }

          .upload-icon {
            font-size: 2.5rem;
          }

          .stat-card {
            padding: 15px;
          }

          .stat-value {
            font-size: 1.4rem;
          }

          .summary-card {
            padding: 20px;
          }

          .summary-card .value {
            font-size: 1.6rem;
          }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="main-card">
        <div class="header">
            <div class="header-content">
                <h1>📊 DataVision</h1>
                <p>Продвинутый анализ данных CSV с визуализацией и статистикой</p>
            </div>
        </div>

        <div class="main-content">
            <div class="upload-section">
                <h2 class="section-title">Импорт данных</h2>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">📁</div>
                    <h3>Перетащите CSV файл сюда</h3>
                    <p>или нажмите для выбора файла</p>
                    <p class="city-info">Поддерживаются файлы с полями: name, segment, state, city, order_date, ship_mode, sales</p>
                    <input type="file" id="fileInput" class="file-input" accept=".csv">
                </div>
                <button class="btn pulse" id="selectFileBtn">
                    <span>📎 Выбрать файл</span>
                </button>
                <div class="action-buttons">
                    <button class="btn btn-secondary" id="resetBtn" style="display: none;">
                        <span>🔄 Загрузить другой файл</span>
                    </button>
                </div>
            </div>

            <div class="analysis-section">
                <div id="processingInfo"></div>

                <div id="analysisContent" class="hidden fade-in">
                    <h2 class="section-title">Результаты анализа</h2>
                    <div id="summary"></div>

                    <div id="emptyCellsWarning" class="empty-cells-warning hidden">
                        <h4>⚠️ Обнаружены пустые ячейки:</h4>
                        <div class="empty-cells-list" id="emptyCellsList"></div>
                    </div>

                    <div id="dataIssues" class="data-issues hidden">
                        <h4>⚠️ Обнаружены проблемы с данными:</h4>
                        <div class="issues-list" id="issuesList"></div>
                    </div>

                    <div id="missingStatesWarning" class="missing-states hidden">
                        <h4>⚠️ Отсутствуют данные для следующих штатов:</h4>
                        <div class="missing-states-list" id="missingStatesList"></div>
                    </div>

                    <div class="year-selector">
                        <label for="yearSelect" style="font-weight: 500;">Год анализа:</label>
                        <select id="yearSelect" class="select"></select>
                        <button id="analyzeBtn" class="btn">🔄 Обновить анализ</button>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                            <tr>
                                <th>Штат</th>
                                <th>Город с максимальной выручкой</th>
                                <th>Выручка</th>
                                <th>Доля от общей выручки</th>
                            </tr>
                            </thead>
                            <tbody id="data-table-body"></tbody>
                        </table>
                    </div>

                    <div id="barChart" class="bar-chart hidden">
                        <div class="bar-chart-title">📈 Распределение выручки по штатам</div>
                        <div id="barChartContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Элементы
    const fileInput = document.getElementById('fileInput');
    const uploadArea = document.getElementById('uploadArea');
    const selectFileBtn = document.getElementById('selectFileBtn');
    const resetBtn = document.getElementById('resetBtn');
    const processingInfoDiv = document.getElementById('processingInfo');
    const analysisContent = document.getElementById('analysisContent');
    const summaryDiv = document.getElementById('summary');
    const dataTableBody = document.getElementById('data-table-body');
    const yearSelect = document.getElementById('yearSelect');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const missingStatesWarning = document.getElementById('missingStatesWarning');
    const missingStatesList = document.getElementById('missingStatesList');
    const dataIssues = document.getElementById('dataIssues');
    const issuesList = document.getElementById('issuesList');
    const emptyCellsWarning = document.getElementById('emptyCellsWarning');
    const emptyCellsList = document.getElementById('emptyCellsList');
    const barChart = document.getElementById('barChart');
    const barChartContent = document.getElementById('barChartContent');

    let ordersData = [];
    let currentValidData = [];
    let currentFileName = '';
    let totalRevenueAllYears = 0;

    // Инициализация
    selectFileBtn.addEventListener('click', () => fileInput.click());
    resetBtn.addEventListener('click', resetFileInput);

    // Drag and drop functionality
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('active');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('active');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('active');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        fileInput.files = files;
        handleFileUpload();
      }
    });

    fileInput.addEventListener('change', handleFileUpload);

    function resetFileInput() {
      fileInput.value = '';
      uploadArea.classList.remove('has-error');
      uploadArea.innerHTML = `
        <div class="upload-icon">📁</div>
        <h3>Перетащите CSV файл сюда</h3>
        <p>или нажмите для выбора файла</p>
        <p class="city-info">Поддерживаются файлы с полями: name, segment, state, city, order_date, ship_mode, sales</p>
        <input type="file" id="fileInput" class="file-input" accept=".csv">
      `;
      processingInfoDiv.innerHTML = '';
      analysisContent.classList.add('hidden');
      missingStatesWarning.classList.add('hidden');
      dataIssues.classList.add('hidden');
      emptyCellsWarning.classList.add('hidden');
      barChart.classList.add('hidden');
      resetBtn.style.display = 'none';
      currentFileName = '';
      totalRevenueAllYears = 0;
    }

    function handleFileUpload() {
      const file = fileInput.files[0];
      if (!file) return;

      currentFileName = file.name;

      uploadArea.innerHTML = `
        <div class="upload-icon">⏳</div>
        <h3>${file.name}</h3>
        <p>Обработка файла...</p>
      `;

      resetBtn.style.display = 'inline-flex';

      const reader = new FileReader();
      reader.onload = function(event) {
        processingInfoDiv.innerHTML = '';
        analysisContent.classList.add('hidden');
        missingStatesWarning.classList.add('hidden');
        dataIssues.classList.add('hidden');
        emptyCellsWarning.classList.add('hidden');
        barChart.classList.add('hidden');

        try {
          const parseResult = parseCSV(event.target.result);
          ordersData = parseResult.data;

          const headers = ordersData.length > 0 ? Object.keys(ordersData[0]) : [];
          const validation = validateFields(headers, ordersData);

          if (!validation.isValid) {
            uploadArea.classList.add('has-error');
            uploadArea.innerHTML = `
              <div class="upload-icon">❌</div>
              <h3>${file.name}</h3>
              <p style="color: var(--error);">Файл содержит ошибки</p>
              <input type="file" id="fileInput" class="file-input" accept=".csv">
            `;
            showStatus('error', validation.message);
            return;
          }

          uploadArea.classList.remove('has-error');
          uploadArea.innerHTML = `
            <div class="upload-icon">✅</div>
            <h3>${file.name}</h3>
            <p style="color: var(--success);">Файл успешно загружен</p>
            <input type="file" id="fileInput" class="file-input" accept=".csv">
          `;

          showStatus('success', validation.message);

          // Показываем информацию о пустых ячейках
          if (parseResult.emptyCellsCount > 0) {
            showEmptyCellsWarning(parseResult.emptyCellsCount);
          }

          const qualityResult = checkDataQuality(ordersData);
          const { validData, qualityInfo, missingStates, allYearsRevenue, dataProblems } = qualityResult;
          currentValidData = validData;
          totalRevenueAllYears = allYearsRevenue;

          showQualityStats(qualityInfo);
          showDataProblems(dataProblems);

          if (validData.length > 0) {
            setTimeout(() => {
              analysisContent.classList.remove('hidden');
              analysisContent.classList.add('fade-in');
              showYearAnalysis(validData, missingStates);
            }, 500);
          } else {
            showStatus('warning', 'Нет валидных данных для анализа после обработки ошибок');
          }

        } catch(err) {
          uploadArea.classList.add('has-error');
          uploadArea.innerHTML = `
            <div class="upload-icon">❌</div>
            <h3>${file.name}</h3>
            <p style="color: var(--error);">Ошибка при чтении файла</p>
            <input type="file" id="fileInput" class="file-input" accept=".csv">
          `;
          showStatus('error', `Ошибка при обработке файла: ${err.message}`);
          return;
        }
      };

      reader.onerror = function() {
        uploadArea.classList.add('has-error');
        uploadArea.innerHTML = `
          <div class="upload-icon">❌</div>
          <h3>${file.name}</h3>
          <p style="color: var(--error);">Ошибка чтения файла</p>
          <input type="file" id="fileInput" class="file-input" accept=".csv">
        `;
        showStatus('error', 'Ошибка при чтении файла');
        resetBtn.style.display = 'inline-flex';
      };

      reader.readAsText(file, 'UTF-8');
    }

    function showStatus(type, message) {
      const typeClass = `status-${type}`;
      processingInfoDiv.innerHTML = `
        <div class="status-card ${typeClass} fade-in">
          <strong>${type === 'success' ? '✅' : type === 'error' ? '❌' : '⚠️'} ${type === 'success' ? 'Успех' : type === 'error' ? 'Ошибка' : 'Внимание'}:</strong> ${message}
        </div>
      `;
    }

    function showQualityStats(qualityInfo) {
      const statsHtml = `
        <div class="quality-stats fade-in">
          <div class="stat-card">
            <div class="stat-value">${qualityInfo.totalRows}</div>
            <div class="stat-label">Всего строк</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" style="color: ${qualityInfo.uniqueRowsWithMissingValues > 0 ? 'var(--warning)' : 'var(--success)'}">${qualityInfo.uniqueRowsWithMissingValues}</div>
            <div class="stat-label">Пропущенные значения</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" style="color: ${qualityInfo.invalidDates > 0 ? 'var(--warning)' : 'var(--success)'}">${qualityInfo.invalidDates}</div>
            <div class="stat-label">Некорректные даты</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" style="color: ${qualityInfo.validRows > 0 ? 'var(--success)' : 'var(--error)'}">${qualityInfo.validRows}</div>
            <div class="stat-label">Валидные строки</div>
          </div>
        </div>
      `;
      processingInfoDiv.innerHTML += statsHtml;
    }

    function showDataProblems(problems) {
      if (problems.invalidDates > 0 || problems.negativeValues > 0 || problems.outliers > 0) {
        dataIssues.classList.remove('hidden');
        issuesList.innerHTML = '';

        if (problems.invalidDates > 0) {
          const issue = document.createElement('div');
          issue.className = 'issue-item';
          issue.innerHTML = `❌ Некорректные даты: ${problems.invalidDates} записей`;
          issuesList.appendChild(issue);
        }

        if (problems.negativeValues > 0) {
          const issue = document.createElement('div');
          issue.className = 'issue-item';
          issue.innerHTML = `⚠️ Отрицательные значения: ${problems.negativeValues} записей`;
          issuesList.appendChild(issue);
        }

        if (problems.outliers > 0) {
          const issue = document.createElement('div');
          issue.className = 'issue-item';
          issue.innerHTML = `📈 Выбросы (большие значения): ${problems.outliers} записей`;
          issuesList.appendChild(issue);
        }
      }
    }

    function showEmptyCellsWarning(emptyCellsCount) {
      emptyCellsWarning.classList.remove('hidden');
      emptyCellsList.innerHTML = '';

      const cellItem = document.createElement('div');
      cellItem.className = 'empty-cell-item';
      cellItem.innerHTML = `
        <span>📝</span>
        <span>Обнаружено <strong>${emptyCellsCount} пустых ячеек</strong> - в них отсутствуют данные</span>
      `;
      emptyCellsList.appendChild(cellItem);
    }

    function parseCSV(text) {
      if (!text.trim()) {
        throw new Error('Файл пуст');
      }

      const lines = text.trim().split(/\r?\n/);

      if (lines.length === 0) {
        throw new Error('Файл не содержит данных');
      }

      const headers = lines[0].split(',').map(h => h.trim());

      if (headers.length === 0) {
        throw new Error('Не найдены заголовки столбцов');
      }

      const data = [];
      let emptyCellsCount = 0;

      for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;

        const parts = [];
        let current = '';
        let inQuotes = false;

        for (let j = 0; j < lines[i].length; j++) {
          const c = lines[i][j];
          if (c === '"') {
            inQuotes = !inQuotes;
          } else if (c === ',' && !inQuotes) {
            parts.push(current.trim());
            current = '';
          } else {
            current += c;
          }
        }
        parts.push(current.trim());

        const obj = {};
        headers.forEach((h, idx) => {
          const value = parts[idx] || '';
          obj[h] = value;

          // Подсчитываем пустые ячейки
          if (!value.trim()) {
            emptyCellsCount++;
          }
        });

        data.push(obj);
      }

      return { data, emptyCellsCount };
    }

    function validateFields(headers, data) {
      const requiredFields = ['name', 'segment', 'state', 'city', 'order_date', 'ship_mode', 'sales'];
      const headersLower = headers.map(h => h.toLowerCase());

      if (headers.length === 0) {
        return {
          isValid: false,
          message: 'Файл пуст',
          errorType: 'empty_file'
        };
      }

      if (headers.length > 0 && data.length === 0) {
        return {
          isValid: false,
          message: 'Файл содержит только заголовки без данных',
          errorType: 'no_entries'
        };
      }

      const matchedFields = requiredFields.filter(field =>
        headersLower.includes(field.toLowerCase())
      );

      if (matchedFields.length === 0) {
        return {
          isValid: false,
          message: `Все поля не соответствуют требуемым. Ожидаемые поля: ${requiredFields.join(', ')}. Найдены поля: ${headers.join(', ')}`,
          errorType: 'invalid_fields'
        };
      }

      if (matchedFields.length < requiredFields.length) {
        const missingFields = requiredFields.filter(field =>
          !headersLower.includes(field.toLowerCase())
        );
        return {
          isValid: false,
          message: `Отсутствуют обязательные поля: ${missingFields.join(', ')}. Найдены поля: ${headers.join(', ')}`,
          errorType: 'missing_fields'
        };
      }

      return {
        isValid: true,
        message: 'Все поля корректны. Файл готов к анализу.',
        errorType: 'valid'
      };
    }

    function checkDataQuality(data) {
      const qualityInfo = {
        totalRows: data.length,
        missingValues: 0,
        invalidDates: 0,
        outliers: 0,
        negativeValues: 0,
        validRows: 0,
        rowsWithMissingValues: new Set()
      };

      const dataProblems = {
        invalidDates: 0,
        negativeValues: 0,
        outliers: 0
      };

      const validData = [];
      const missingStates = new Set();
      let allYearsRevenue = 0;

      const headers = Object.keys(data[0] || {});
      const headersLower = headers.map(h => h.toLowerCase());

      const dateField = headers.find(h => h.toLowerCase().includes('date'));
      const stateField = headers.find(h => h.toLowerCase().includes('state'));
      const cityField = headers.find(h => h.toLowerCase().includes('city'));
      const salesField = headers.find(h => h.toLowerCase().includes('sales'));

      data.forEach((row, index) => {
        let isValid = true;
        let hasMissingValue = false;
        let hasInvalidDate = false;
        let hasOutlier = false;
        let hasNegativeValue = false;

        const importantFields = [stateField, dateField, salesField].filter(Boolean);
        for (const field of importantFields) {
          if (!row[field] || row[field].trim() === '') {
            hasMissingValue = true;
            qualityInfo.missingValues++;
            qualityInfo.rowsWithMissingValues.add(index);

            if (field === stateField && row[stateField]) {
              missingStates.add(row[stateField]);
            }
            break;
          }
        }

        if (dateField && row[dateField]) {
          const date = new Date(row[dateField]);
          if (isNaN(date.getTime())) {
            hasInvalidDate = true;
            qualityInfo.invalidDates++;
            dataProblems.invalidDates++;
          } else {
            row._date = date;
            row._year = date.getFullYear();
          }
        }

        if (salesField && row[salesField]) {
          let salesValue = row[salesField];
          salesValue = String(salesValue).replace(/[^0-9.\-]/g, '');
          const salesNum = parseFloat(salesValue);

          if (isNaN(salesNum)) {
            hasMissingValue = true;
            qualityInfo.missingValues++;
            qualityInfo.rowsWithMissingValues.add(index);
          } else {
            row._sales = salesNum;
            allYearsRevenue += salesNum;

            if (salesNum < 0) {
              hasNegativeValue = true;
              qualityInfo.negativeValues++;
              dataProblems.negativeValues++;
            }

            if (salesNum > 1000000) {
              hasOutlier = true;
              qualityInfo.outliers++;
              dataProblems.outliers++;
            }
          }
        } else {
          hasMissingValue = true;
          qualityInfo.missingValues++;
          qualityInfo.rowsWithMissingValues.add(index);
        }

        if (stateField) {
          row._state = row[stateField] || "Unknown";
        }

        if (cityField) {
          row._city = row[cityField] || "Unknown";
        }

        if (!hasMissingValue && !hasInvalidDate && !hasNegativeValue) {
          validData.push(row);
          qualityInfo.validRows++;
        }
      });

      qualityInfo.uniqueRowsWithMissingValues = qualityInfo.rowsWithMissingValues.size;

      return {
        validData,
        qualityInfo,
        missingStates: Array.from(missingStates),
        allYearsRevenue,
        dataProblems
      };
    }

    function showYearAnalysis(validData, missingStates) {
      const years = new Set();
      validData.forEach(item => {
        if (item._year) years.add(item._year);
      });

      const sortedYears = Array.from(years).sort();

      yearSelect.innerHTML = '';
      sortedYears.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      });

      if (missingStates.length > 0) {
        missingStatesWarning.classList.remove('hidden');
        missingStatesList.innerHTML = '';
        missingStates.forEach(state => {
          const stateTag = document.createElement('span');
          stateTag.className = 'state-tag';
          stateTag.textContent = state;
          missingStatesList.appendChild(stateTag);
        });
      }

      if (sortedYears.length > 0) {
        analyzeYearData(validData, sortedYears[0]);
      }

      analyzeBtn.onclick = () => {
        const selectedYear = parseInt(yearSelect.value);
        analyzeYearData(validData, selectedYear);
      };
    }

    function analyzeYearData(data, year) {
      const filtered = data.filter(item => item._year === year);

      if (filtered.length === 0) {
        summaryDiv.innerHTML = `<div class="status-warning">Нет данных за ${year} год.</div>`;
        dataTableBody.innerHTML = '';
        barChart.classList.add('hidden');
        return;
      }

      // Собираем статистику по штатам и городам
      const stats = {};

      filtered.forEach(item => {
        const state = item._state || 'Unknown';
        const city = item._city || 'Unknown';
        const sales = item._sales || 0;

        // Статистика по штатам
        if (!stats[state]) {
          stats[state] = { revenue: 0, cities: {} };
        }
        stats[state].revenue += sales;

        // Статистика по городам внутри штата
        if (!stats[state].cities[city]) {
          stats[state].cities[city] = 0;
        }
        stats[state].cities[city] += sales;
      });

      // Находим город с максимальной выручкой для каждого штата
      Object.keys(stats).forEach(state => {
        const cities = stats[state].cities;
        let maxCity = '';
        let maxRevenue = 0;

        Object.keys(cities).forEach(city => {
          if (cities[city] > maxRevenue) {
            maxRevenue = cities[city];
            maxCity = city;
          }
        });

        stats[state].topCity = maxCity;
        stats[state].topCityRevenue = maxRevenue;
      });

      const topArray = Object.entries(stats)
        .map(([state, val]) => ({
          state,
          revenue: val.revenue,
          topCity: val.topCity || 'Нет данных',
          topCityRevenue: val.topCityRevenue || 0
        }))
        .sort((a,b) => b.revenue - a.revenue)
        .slice(0, 10);

      const totalRevenue = Object.values(stats).reduce((sum,val) => sum + val.revenue, 0);
      const percentageOfTotal = totalRevenueAllYears > 0 ? ((totalRevenue / totalRevenueAllYears) * 100).toFixed(1) : 0;

      summaryDiv.innerHTML = `
        <div class="summary-cards">
          <div class="summary-card">
            <div class="summary-card-content">
              <h3>Общая выручка за ${year} год</h3>
              <div class="value">$${totalRevenue.toLocaleString()}</div>
              <p>${percentageOfTotal}% от общей выручки</p>
            </div>
          </div>
          <div class="summary-card">
            <div class="summary-card-content">
              <h3>Проанализировано записей</h3>
              <div class="value">${filtered.length}</div>
            </div>
          </div>
          <div class="summary-card">
            <div class="summary-card-content">
              <h3>Количество штатов</h3>
              <div class="value">${Object.keys(stats).length}</div>
            </div>
          </div>
        </div>
      `;

      dataTableBody.innerHTML = '';
      topArray.forEach(({state, revenue, topCity, topCityRevenue}) => {
        const sharePercent = totalRevenue > 0 ? ((revenue / totalRevenue) * 100).toFixed(2) : '0.00';
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <strong>${state}</strong>
          </td>
          <td>
            <div><strong>${topCity}</strong></div>
            <div class="city-info">Выручка: $${topCityRevenue.toLocaleString()}</div>
          </td>
          <td>$${revenue.toLocaleString()}</td>
          <td><strong>${sharePercent}%</strong></td>
        `;
        dataTableBody.appendChild(row);
      });

      // Строчная диаграdcкермма
      createBarChart(stats, totalRevenue);
    }

    function createBarChart(stats, totalRevenue) {
      barChart.classList.remove('hidden');

      // Сортируем штаты по выручке
      const sortedStats = Object.entries(stats)
        .map(([state, val]) => ({ state, revenue: val.revenue, topCity: val.topCity }))
        .sort((a, b) => b.revenue - a.revenue)
        .slice(0, 15); // Показываем топ-15 штатов

      barChartContent.innerHTML = '';

      sortedStats.forEach(({state, revenue, topCity}) => {
        const percentage = totalRevenue > 0 ? (revenue / totalRevenue * 100) : 0;
        const barWidth = Math.max(percentage, 1); // Минимальная ширина 1%

        const barItem = document.createElement('div');
        barItem.className = 'bar-item';
        barItem.innerHTML = `
          <div class="bar-label">
            <div><strong>${state}</strong></div>
            <div class="city-info">${topCity}</div>
          </div>
          <div class="bar-container">
            <div class="bar-fill" style="width: ${barWidth}%">
              <span class="bar-percentage">${percentage.toFixed(1)}%</span>
            </div>
            <span class="bar-value">$${revenue.toLocaleString()}</span>
          </div>
        `;

        barChartContent.appendChild(barItem);

        // Анимация появления
        setTimeout(() => {
          const barFill = barItem.querySelector('.bar-fill');
          barFill.style.width = `${barWidth}%`;
        }, 100);
      });
    }
</script>
</body>
</html>